{% extends 'base.html' %}

{% block title %}Gestión de multas | Licorería{% endblock %}

{% block header_title %}Control de Multas{% endblock %}

{% block content %}
<div class="container" style="margin-top: 2rem;">
    <!-- Header Section -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h2 style="color: var(--accent-danger); margin: 0; font-size: 2rem; font-weight: 700;">
                <i class="ph ph-warning-octagon" style="margin-right: 10px;"></i>
                Control de Multas
            </h2>
            <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                Gestión de aplicación de multas
            </p>
        </div>
        <div
            style="background: rgba(239, 68, 68, 0.1); padding: 15px 25px; border-radius: 12px; border: 1px solid var(--accent-danger);">
            <div
                style="font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">
                Total Deuda Pendiente
            </div>
            <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-danger);">
                {% with total=0 %}
                {% for o in ordenes %}{% with total=total|add:o.total %}{% endwith %}{% endfor %}
                <!-- Placeholder simplificado, idealmente calculado en vista -->
                {{ ordenes.count }} Casos
                {% endwith %}
            </div>
        </div>
    </div>

    <!-- Main Table -->
    <div class="card"
        style="background: var(--bg-card); border: 1px solid var(--border); padding: 0; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
        <div style="overflow-x: auto;">
            <table class="table" style="margin: 0; color: var(--text-primary);">
                <thead>
                    <tr style="background: rgba(255, 255, 255, 0.02);">
                        <th style="padding: 1.2rem; min-width: 120px;">Código</th>
                        <th style="padding: 1.2rem; min-width: 200px;">Cliente</th>
                        <th style="padding: 1.2rem; min-width: 150px;">Fecha Orden</th>
                        <th style="padding: 1.2rem; text-align: right; min-width: 150px;">Monto Préstamo</th>
                        <th style="padding: 1.2rem; text-align: right; min-width: 150px;">Deuda Multas</th>
                        <th style="padding: 1.2rem; text-align: center; min-width: 150px;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for o in ordenes %}
                    <tr style="border-bottom: 1px solid var(--border); transition: all 0.3s ease;">
                        <td style="padding: 1.2rem;">
                            <span
                                style="font-family: monospace; background: rgba(239, 68, 68, 0.1); padding: 6px 12px; border-radius: 8px; color: var(--accent-danger); border: 1px solid rgba(239, 68, 68, 0.2); font-weight: 700;">
                                #{{ o.codigo_orden }}
                            </span>
                        </td>
                        <td style="padding: 1.2rem;">
                            <div style="font-weight: 600; color: white; margin-bottom: 4px;">{{ o.cliente.nombre }}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                <i class="ph ph-phone" style="font-size: 0.8rem;"></i> {{ o.cliente.telefono }}
                            </div>
                        </td>
                        <td style="padding: 1.2rem;">
                            <div style="color: var(--text-primary);">{{ o.fecha|date:"d M Y" }}</div>
                            <div style="font-size: 0.8rem; color: var(--accent-danger);">
                                <!-- Calcular días de retraso idealmente en backend -->
                                Pendiente
                            </div>
                        </td>
                        <td style="padding: 1.2rem; text-align: right;">
                            <div
                                style="font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 1.1rem; color: white;">
                                ${{ o.total|floatformat:2 }}
                            </div>
                        </td>
                        <td style="padding: 1.2rem; text-align: right;">
                            <span style="color: var(--accent-danger); font-weight: 600;">
                                ${{ o.cliente.total_deuda_multas|floatformat:2 }}
                            </span>
                        </td>
                        <td style="padding: 1.2rem; text-align: center;">
                            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                <a href="{% url 'detalle_orden' o.id %}" class="btn-icon"
                                    style="background: rgba(0, 243, 255, 0.1); color: var(--accent-primary); width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: 1px solid var(--accent-primary); transition: all 0.2s;">
                                    <i class="ph ph-eye"></i>
                                </a>
                                <button type="button" onclick="abrirModalCobro('{{ o.id }}', '{{ o.codigo_orden }}')"
                                    style="background: rgba(239, 68, 68, 0.1); color: var(--accent-danger); border: 1px solid var(--accent-danger); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; transition: all 0.2s;"
                                    onmouseover="this.style.background='var(--accent-danger)'; this.style.color='white';"
                                    onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.color='var(--accent-danger)';">
                                    <i class="ph ph-gavel"></i> Multar
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 4rem 2rem;">
                            <div style="opacity: 0.5;">
                                <i class="ph ph-shield-check"
                                    style="font-size: 4rem; color: var(--accent-success); margin-bottom: 1rem;"></i>
                                <h3 style="color: white; margin-bottom: 0.5rem;">Todo al día</h3>
                                <p style="color: var(--text-secondary); margin: 0;">No hay órdenes pendientes de cobro
                                    en este momento.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Estilo adicional para hover de filas -->
<style>
    tbody tr:hover {
        background: rgba(239, 68, 68, 0.05) !important;
    }

    .btn-icon:hover {
        background: var(--accent-primary) !important;
        color: black !important;
    }
</style>

<!-- Modal Multa - Único y fuera de la tabla -->
<div id="modalCobro"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
    <div
        style="background: var(--bg-card); padding: 2.5rem; border-radius: 24px; border: 1px solid var(--accent-danger); width: 90%; max-width: 480px; position: relative; box-shadow: 0 20px 50px rgba(239, 68, 68, 0.2);">
        <button onclick="document.getElementById('modalCobro').style.display='none'"
            style="position: absolute; top: 1.5rem; right: 1.5rem; background: none; border: none; color: var(--text-secondary); cursor: pointer; transition: color 0.2s;">
            <i class="ph ph-x" style="font-size: 1.5rem;"></i>
        </button>

        <div style="text-align: center; margin-bottom: 2rem;">
            <div
                style="width: 60px; height: 60px; background: rgba(239, 68, 68, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem auto; border: 1px solid var(--accent-danger);">
                <i class="ph ph-gavel" style="font-size: 1.8rem; color: var(--accent-danger);"></i>
            </div>
            <h3 style="color: white; margin: 0; font-size: 1.5rem;">Aplicar Multa</h3>
            <p style="color: var(--text-secondary); margin-top: 0.5rem;">Orden <span id="spanCodigoCobro"
                    style="color: var(--accent-danger); font-weight: 700;"></span></p>
        </div>

        <form id="formCobro" method="POST" action="">
            {% csrf_token %}

            <div style="margin-bottom: 1.2rem;">
                <label
                    style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">Tipo
                    de Infracción</label>
                <div style="position: relative;">
                    <i class="ph ph-warning-circle"
                        style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
                    <select name="tipo"
                        style="width: 100%; background: var(--bg-body); border: 1px solid var(--border); color: white; padding: 12px 12px 12px 40px; border-radius: 12px; appearance: none; cursor: pointer; outline: none; transition: border-color 0.2s;">
                        <option value="TARD" selected>Pago Tardío de Orden</option>
                        <option value="DANO">Daño a Instalaciones</option>
                        <option value="COMP">Comportamiento Inadecuado</option>
                        <option value="OTRO">Otras Sanciones</option>
                    </select>
                    <i class="ph ph-caret-down"
                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none;"></i>
                </div>
            </div>

            <div style="margin-bottom: 1.2rem;">
                <label
                    style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">Monto
                    a Penalizar ($)</label>
                <div style="position: relative;">
                    <i class="ph ph-currency-dollar"
                        style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
                    <input type="number" name="monto" step="0.01" required value="5.00"
                        style="width: 100%; background: var(--bg-body); border: 1px solid var(--border); color: white; padding: 12px 12px 12px 40px; border-radius: 12px; outline: none; transition: border-color 0.2s;">
                </div>
            </div>

            <div style="margin-bottom: 2rem;">
                <label
                    style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">Descripción
                    / Observaciones</label>
                <textarea name="descripcion" rows="3" required
                    style="width: 100%; background: var(--bg-body); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 12px; resize: none; outline: none; transition: border-color 0.2s;">Recargo por retraso en el pago</textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <button type="button" onclick="document.getElementById('modalCobro').style.display='none'" class="btn"
                    style="background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--border); padding: 12px; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    Cancelar
                </button>
                <button type="submit" class="btn"
                    style="background: var(--accent-danger); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); transition: all 0.2s;">
                    Confirmar Multa
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function abrirModalCobro(id, codigo) {
        document.getElementById('modalCobro').style.display = 'flex';
        document.getElementById('spanCodigoCobro').innerText = '#' + codigo;
        // Construir URL dinámica
        let urlBase = "{% url 'aplicar_multa' 0 %}".replace('/0/', '/' + id + '/');
        document.getElementById('formCobro').action = urlBase;
    }

    // Cerrar modal al hacer clic fuera
    window.onclick = function (event) {
        let modal = document.getElementById('modalCobro');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
{% endblock %}